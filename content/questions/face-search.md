---
filename: face-search.md
title: Поиск лица на изображении
Summary: >
  
date: 2022-01-11T15:39:50+03:00
билеты: ["Билет 16", ]
draft: false
weight: 25
cover:
  image: https://i.ytimg.com/vi/kKaU6JFRu5g/maxresdefault.jpg
author: "Ilya Kochankov"
---

## Метод Виолы-Джонса
### Определениеё

Метод был разработан и представлен в 2001 году Полом Виолой и Майклом Джонсом, 
он до сих пор является основополагающим для поиска объектов на изображении в реальном времени.

Метод использует технологию скользящего окна. То есть рамка, размером, меньшим, чем исходное изображение,
двигается с некоторым шагом по изображению, и с помощью каскада слабых классификаторов определяет, 
есть ли в рассматриваемом окне лицо.

Метод скользящего окно эффективно используется в различных задачах компьютерного зрения и распознавания объектов.

### Приемущества

Метод имеет следующие преимущества:

- возможно обнаружение более одного лица на изображении;
- использование простых классификаторов показывает хорошую скорость и позволяет использовать этот метод в видеопотоке.

Обучение классификаторов идет очень медленно, но результаты поиска лица очень быстры, 
именно поэтому был выбран данный метод распознавания лиц на изображении. 

Виола-Джонс является одним из лучших по соотношению показателей эффективность распознавания/скорость работы. 
Также этот детектор обладает крайне низкой вероятностью ложного обнаружения лица. 

Алгоритм даже хорошо работает и распознает черты лица под небольшим углом, примерно до 30 градусов. 
При угле наклона больше 30 градусов процент обнаружений резко падает. 

И это не позволяет в стандартной реализации детектировать повернутое лицо человека под произвольным углом, 
что в значительной мере затрудняет или делает невозможным использование алгоритма в современных 
производственных системах с учетом их растущих потребностей.

Изначально алгоритм был предложен для распознавания только лиц, но его можно использовать для распознавания других объектов.

### Основные принципы

Основные принципы, на которых основан метод, таковы:

- используются изображения в интегральном представлении, что позволяет вычислять быстро необходимые объекты;
- используются признаки Хаара, с помощью которых происходит поиск нужного объекта (в данном контексте, лица и его черт);
- используется бустинг (от англ. boost – улучшение, усиление) для выбора наиболее подходящих признаков для искомого объекта на данной части изображения;
- все признаки поступают на вход классификатора, который даёт результат «верно» либо «ложь»;
используются каскады признаков для быстрого отбрасывания окон, где не найдено лицо.

### Принцип сканирующего окна

В общем виде, задача обнаружения лица и черт лица человека на цифровом изображении выглядит именно так:

- имеется изображение, на котором есть искомые объекты. Оно представлено двумерной матрицей 
пикселей размером w*h, в которой каждый пиксель имеет значение:
  - от 0 до 255, если это черно-белое изображение;
  - от 0 до 255^3, если это цветное изображение (компоненты R, G, B).

в результате своей работы, алгоритм должен определить лица и их черты и пометить их – поиск 
осуществляется в активной области изображения прямоугольными признаками, 
с помощью которых и описывается найденное лицо и его черты:
rectanglei = {x,y,w,h,a}

где x, y – координаты центра i-го прямоугольника, w – ширина, h – высота, a – угол наклона прямоугольника 
к вертикальной оси изображения.

Иными словами, применительно к рисункам и фотографиям используется подход на основе сканирующего окна (scanning window): 
сканируется изображение окном поиска (так называемое, окно сканирования), 
а затем применяется классификатор к каждому положению.

Алгоритм сканирования окна с признаками выглядит так: есть исследуемое изображение, 
выбрано окно сканирования, выбраны используемые признаки; 

Далее окно сканирования начинает последовательно двигаться по изображению с шагом в 1 ячейку окна
(допустим, размер самого окна есть 24*24 ячейки);

При сканировании изображения в каждом окне вычисляется приблизительно 200 000 вариантов расположения признаков,
за счет изменения масштаба признаков и их положения в окне сканирования; 

Сканирование производится последовательно для различных масштабов; 

Масштабируется не само изображение, а сканирующее окно (изменяется размер ячейки); 

Все найденные признаки попадают к классификатору, который «выносит вердикт».

## Генерация гипотиз

1. Цикл по масштабу и координатам (сканирующее окно)
2. Фильтруются заведомо ложные гипотезы: 
   - Проверяется наличие рёбер/градиентов (они должны присутствовать) 
   - Средняя интенсивность в лице не может быть очень большой или очень малой
3. По оставшимся вариантам строится вектор признаков и происходит классификация методом adaboost

## Признаки Хаара

Признаки Хаара — признаки цифрового изображения, используемые в распознавании образов. 

Признаки Хаара использовались в первом детекторе лиц, работающем в реальном времени.

Признак Хаара состоит из смежных прямоугольных областей. Они позиционируются на изображении, далее 
суммируются интенсивности пикселей в областях, после чего вычисляется разность между суммами. 

Эта разность и будет значением определенного признака, определенного размера, определенным образом спозиционированного 
на изображении.

Для примера рассмотрим базу данных с человеческими лицами. Общим для всех изображений является то, что область в районе глаз темнее, чем область в районе щек. 

Следовательно общим признаком Хаара для лиц является 2 смежных прямоугольных региона, лежащих на глазах и щеках.

Ключевой особенностью признаков Хаара является наибольшая, по сравнению с остальными признаками, скорость.

При использовании интегрального представления изображения, признаки Хаара могут вычисляться за постоянное время 
(примерно 60 процессорных инструкций на признак из двух областей).

В стандартном методе Виолы – Джонса используются прямоугольные признаки, изображенные на рисунке. Они называются примитивами Хаара.

{{< figure src="https://studfile.net/html/2706/270/html_1VlikOL_uD.ncDa/img-iBv_p4.jpg"
class="figure__image" >}}

В расширенном методе Виолы – Джонса, использующемся в библиотеке OpenCV используются дополнительные признаки, показанные на рисунке:

{{< figure src="https://studfile.net/html/2706/270/html_1VlikOL_uD.ncDa/img-tHNWon.jpg"
class="figure__image" >}}

Вычисляемым значением такого признака будет:

F = X-Y, (1.5) где X– сумма значений яркостей точек закрываемыхсветлой частью признака, 
Y– сумма значений яркостей точек закрываемыхтемной частью признака.

Для их вычисления используется понятие интегрального изображения, рассмотренное выше. 
Признаки Хаара дают точечное значение перепада яркости по оси X и Y соответственно.

### Прямоугольные признаки Хаара

Простейший прямоугольный признак Хаара можно определить как разность сумм пикселей двух смежных областей внутри 
прямоугольника, который может занимать различные положения и масштабы на изображении. 

акой вид признаков называется 2-прямоугольным. 

Виола и Джонс также определили 3-прямоугольные и 4-прямоугольные признаки. 

Каждый признак может показать наличие (или отсутствие) какой-либо конкретной характеристики изображения, 
такой как границы или изменение текстур.

Например, 2-прямоугольный признак может показать, где находится граница между темным и светлым регионами.

### Наклонные признаки Хаара

Линхарт и Майд представили идею наклоненных (45 градусов) признаков Хаара.

Это было сделано для увеличения размерности пространства признаков. 

Способ оказался удачным и некоторые наклонные признаки были способны лучше описывать объект. 

Например, 2-прямоугольный наклонный признак Хаара может показать наличие края, наклоненного на 45 градусов.

### "Слабый" классификатор

Всего признаков > 100000

По каждому из них можно построить "слабый" классификатор:

{{< figure src="/images/uploads/weak-classifier.png"
class="figure__image" >}}

\\( x_i \\) - вектор размерности 24 x 24, соотвествующий текущему куску изображения

\\( f_j \\) - j-тый признак 

\\( \theta_j \\) - пороговое значение

\\( p_j \\) - знак

### Выбор признаков и классификация

- дано обучающее множество размеченных изображений \\( (x_0, y_0), ... , (x_n, y_n) \\) где \\( y_0 = 0, 1\\) 0 - не лица
а 1 - лица
- Инициализируется массив весов \\( w_{t,i} = \\{ \frac{1}{2m} or \frac{1}{2l} \\} \\) для каждого изображения \\( i \\) где \\( m \\) и \\( l \\) - число
негативных или позитивных примеров
- В цикле для t от 1 до T(кол-во классификаторов)
  - Веса \\( w_t \\) нормируются \\( w_{t,i} = \frac{w_{t,i}}{\sum_{j=1}^n w_{t, j}} \\)
  - Для каждого признака \\( i \\) тренируется "слабый" классификатор \\( h_i \\) и
    вычисляется ошибка классификации \\( \varepsilon_i \\) с весом  \\( w_t \\).

\\( \varepsilon_i  = \sum_i w_i | h_i| \\)


