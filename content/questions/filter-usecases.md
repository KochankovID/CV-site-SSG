---
filename: "filter-usecases.md"
title: "Применение фильтров"
Summary: >
  Фильтрация изображений необходима при реализации фундаментальных операций компьютерного зрения,
  распознавания образов и обработки изображений.
date: 2022-01-08T13:17:45+03:00
билеты: ["Билет 4", "Билет 5"]
draft: false
weight: 9
cover:
  image: https://pyimagesearch.com/wp-content/uploads/2015/10/watershed_output_coins_02.jpg
author: "Ilya Kochankov"
---

## Фильтрация шума на изображении

### Сглаживающий фильтр

{{< figure src="https://studfile.net/html/2706/180/html_bBavfcuupe.QR9Q/img-FU2j96.png"
class="figure__image" >}}

Шум меняется независимо от пикселя к пикселю и, при условии, 
что математическое ожидание значения шума равно нулю, шумы соседних пикселей при суммировании будут компенсировать 
друг друга. 

Чем больше окно фильтрации, тем меньше будет усредненная интенсивность шума, однако при этом будет происходить и 
соответствующее размытие значащих деталей изображения.

Шумоподавление при помощи прямоугольного фильтра имеет существенный недостаток: 
все пиксели в маске фильтра на любом расстоянии от обрабатываемого оказывают на результат одинаковый эффект. 
Несколько лучший результат получается при модификации фильтра с увеличением веса центральной точки:

{{< figure src="https://studfile.net/html/2706/180/html_bBavfcuupe.QR9Q/img-SBAGoA.png"
class="figure__image" >}}

Оригинальное изображение

{{< figure src="https://intuit.ru/EDI/15_10_17_5/1508019676-18691/tutorial/265/objects/8/files/8_1-1.jpg"
class="figure__image" >}}

Сглаживание фильтром с размером 3 x 3

{{< figure src="https://intuit.ru/EDI/15_10_17_5/1508019676-18691/tutorial/265/objects/8/files/8_1-2.jpg"
class="figure__image" >}}

Сглаживание фильтром с размером 7 x 7

{{< figure src="https://intuit.ru/EDI/15_10_17_5/1508019676-18691/tutorial/265/objects/8/files/8_1-3.jpg"
class="figure__image" >}}

Сглаживание фильтром с размером 11 x 11

{{< figure src="https://intuit.ru/EDI/15_10_17_5/1508019676-18691/tutorial/265/objects/8/files/8_1-4.jpg"
class="figure__image" >}}

### Фильтр Гауса

Более эффективное шумоподавление можно осуществить, если влияние пикселей на результат будет уменьшаться 
с увеличением расстояния от обрабатываемого. Этим свойством обладает Гауссовский фильтр. 

Фильтр Гауса имеет ненулевое ядро бесконечного размера. Однако ядро фильтра очень быстро убывает к нулю при 
удалении от точки (0, 0), и потому на практике можно ограничиться сверткой с окном небольшого размера вокруг (0, 0).

{{< figure src="https://russianblogs.com/images/480/f585aae6cfefc838b4a1ad8d413ddc68.png"
class="figure__image" >}}

Как и следовало ожидать, фильтр Гауса более эффективен при шумоподавлении. Влияние пикселей друг на друга при 
гауссовой фильтрации обратно пропорционально квадрату расстояния между ними. 

{{< figure src="http://melvincabatuan.github.io/images/filtering_26_0.png"
class="figure__image" >}}

### Медианный фильтр

Медианная фильтрация способна эффективно справляться с помехами в более общем случае, когда помехи независимо 
воздействуют на отдельные пиксели. Например, такими помехами являются "битые" и "горячие" пиксели при цифровой съемке, 
"снеговой" шум, когда часть пикселей заменяется на пиксели с максимальной интенсивностью, и т.п. 

Преимущество медианной фильтрации перед линейной сглаживающей фильтрацией заключается в том, что "горячий" пиксель на
темном фоне будет заменен на темный, а не "размазан" по окрестности. 

Другими словами медианные фильтры при оптимально 
выбранной апертуре сохраняют без искажений резкие границы объектов, 
подавляя некоррелированные или слабо коррелированные помехи и малоразмерные детали.

Оригинальное изображение

{{< figure src="https://intuit.ru/EDI/15_10_17_5/1508019676-18691/tutorial/265/objects/8/files/8_6-2.jpg"
class="figure__image" >}}

Применение медианного фильтра

{{< figure src="https://intuit.ru/EDI/15_10_17_5/1508019676-18691/tutorial/265/objects/8/files/8_6-3.jpg"
class="figure__image" >}}

Применение сглаживающего фильтра

{{< figure src="https://intuit.ru/EDI/15_10_17_5/1508019676-18691/tutorial/265/objects/8/files/8_6-4.jpg"
class="figure__image" >}}

### Билатеральный фильтр

Билатеральное фильтрование - это нелинейная техника фильтрования. Оно расширяет понятие "сглаживание Гаусса",
увеличивая показатели фильтра соответствующей им относительной интенсивностью пикселя.

Пиксели, которые сильно отличаются по интенсивности от центрального пикселя, увеличиваются в меньшей степени, 
даже несмотря на то, что они могут находиться в непосредственной близости к центральному пикселю, 
что фактически является искривлением нелинейного фильтра Гаусса.

> Эта особенность билатерального фильтра позволяет ему сохранять края на изображении.

{{< figure src="https://www.spiedigitallibrary.org/ContentImages/Proceedings/9631/96310H/FigureImages/00017_psisdg9631_96310H_page_4_3.jpg"
class="figure__image" >}}

---

## Повышение четкости

> Рекомендуется использовать после сильного шумоподавления или когда фокус неудачный

Принцип работы заключается в следующем:

1. Изображение обрабатывается одним из сглаживающих фильтров
2. Полученные значения сравниваются с оригинальными и каким-либо образом усиливают бОльшую разницу

### Пример повышения четкости с простым сглаживающим фильтром

{{< figure src="https://ai.stanford.edu/~syyeung/cvweb/Pictures1/sharpening2.png"
class="figure__image" >}}

### Пример повышения четкости с фильтром Гауса

\\( Image_1[i,j] = Image[i,j] \ – \ (Image * Gaussian)[i,j] \\)

\\( Result[i,j] = | Image_1[i,j] | \leq T \ ? \ Image[i,j] {   } : Image[i,j] + k* Image_1[i,j]\\), \\( k \\) > 0

{{< figure src="/images/uploads/increased-clarity.png"
class="figure__image" >}}

---

## Обнаружение краев (границ) на изображении

### Градиенты изображения

Градиент — векторная величина, показывающая направление наискорейшего возрастания некоторой величины. 

В нашем случае «некоторая величина» — это двумерная функция яркости изображения, допустим что мы рассматриваем 
«псевдонепрерывное» изображение, тогда вектор градиента определяется формулой:

{{< figure src="https://habrastorage.org/r/w1560/storage/habraeffect/93/b3/93b3a96f10fe50414600843bc0c32e6e.png"
class="figure__image" >}}
где \\( I \\) – это наше изображение.

На практике, картинка дискретна и в классическом смысле производной не существует, 
поэтому используют ее разностные аналоги, например в простейшем случае:

{{< figure src="https://habrastorage.org/r/w1560/storage/habraeffect/bb/0b/bb0b6160010376a55e73f009f097ab9f.png"
class="figure__image" >}}

Это левая разностная производная. Разностных аналогов существует великое множество, и все они обладают различными 
порядками аппроксимации, подробнее здесь. 

Увеличение порядка аппроксимации, например как тут в теории должно приводить
к увеличению точности расчета производной. Более того, увеличив количество элементов в аппроксимации можно повысить 
устойчивость к шуму.

После того как изображения градиента были вычислены, пиксели с большими значениями градиента становятся 
возможными краевыми пикселями. Пиксели с наибольшими значениями градиента в направлении градиента становятся краевыми 
пикселями, и края могут отслеживаться в направлении, перпендикулярном направлению градиента.

Градиенты изображения также могут использоваться для надежного сопоставления характеристик и текстуры. 
Различное освещение или свойства камеры могут привести к тому, что два изображения одной сцены будут иметь 
совершенно разные значения пикселей. Это может привести к тому, что алгоритмы сопоставления не смогут 
сопоставить очень похожие или идентичные функции. 

Один из способов решить эту проблему - вычислить текстуру или сигнатуры признаков на основе изображений градиента, 
вычисленных из исходных изображений. Эти градиенты менее восприимчивы к освещению и изменениям камеры, поэтому 
ошибки согласования уменьшаются.

### Разностные фильтры (фильтры находящие границы)

Наиболее распространенный способ аппроксимации градиента изображения - свертка изображения с помощью ядра.

#### Фильтры Прюита и Собеля

{{< figure src="/images/uploads/prewitt-sobel-filter.png"
class="figure__image" >}}

Оператор Собеля представляет собой более неточное приближение градиента изображения, 
но он достаточно качественен для практического применения во многих задачах. 

Точнее, оператор использует значения интенсивности только в окрестности 3×3 каждого пиксела для получения 
приближения соответствующего градиента изображения, и использует только целочисленные значения весовых 
коэффициентов яркости для оценки градиента.

{{< figure src="/images/uploads/sobel-image-filter.png"
class="figure__image" >}}

#### Нахождение границ с помощью фильтра Собеля

Пусть \\( A\\) исходное изображение, а \\(G_x\\) и \\(G_y\\) - два изображения, где каждая точка содержит приближенные
производные по y и по x.

{{< figure src="/images/uploads/image-derivative.png"
class="figure__image" >}}

где * обозначает двухмерную операцию свертки (операцию линейной фильтрации, рассмотренную ранее).

В каждой точке изображения приближенное значение величины градиента можно вычислить, используя полученные значения
\\( G_x \\)  и \\( G_y \\)

{{< figure src="/images/uploads/gradient-summ.png"
class="figure__image" >}}

{{< figure src="/images/uploads/sobel-borders-preview.png"
class="figure__image" >}}

#### Фильтр Лапласа

В цифровой обработке изображений вторая частная производная по координате х в дискретном виде рассчитывается по формуле:

{{< figure src="https://studfile.net/html/2706/35/html_8NcWRIG03c.TExa/img-9oJJdH.png"
class="figure__image" >}}

аналогично для производной по у:

{{< figure src="https://studfile.net/html/2706/35/html_8NcWRIG03c.TExa/img-phObW9.png"
class="figure__image" >}}

Дискретная формулировка двумерного лапласиана получается объединением этих двух составляющих:

{{< figure src="https://studfile.net/html/2706/35/html_8NcWRIG03c.TExa/img-jvKWWD.png"
class="figure__image" >}}

Это уравнение может быть реализованно с помощью маски: 

{{< figure src="/images/uploads/laplas-filter.png"
class="figure__image" >}}

Поскольку оператор Лапласа по сути является второй производной, его применение подчеркивает разрывы уровней 
яркостей на изображении и подавляет области со слабыми изменениями яркостей. 

Это приводит к получению изображения, 
содержащего сероватые линии на месте контуров и других разрывов, наложенные на темный фон без особенностей.

{{< figure src="https://878212.smushcdn.com/1966598/wp-content/uploads/2021/03/OpenCV_21_2-1024x453.jpg?lossy=1&strip=1&webp=1"
class="figure__image" >}}

### Выделение границ методом Canny

Алгоритм:

#### 1) Сглаживание

Размытие изображения для удаления шума. Оператор Кэнни использует фильтр, 
который может быть хорошо приближен к первой производной гауссианы. σ = 1.4:

{{< figure src="https://wikimedia.org/api/rest_v1/media/math/render/svg/efce20969e243d1ba3f34c2f7126041095bd4656"
class="figure__image" >}}

#### 2) Поиск градиентов

Границы отмечаются там, где градиент изображения приобретает максимальное значение. 

Они могут иметь различное направление, поэтому алгоритм Кэнни использует четыре фильтра для обнаружения 
горизонтальных, вертикальных и диагональных ребер в размытом изображении.

{{< figure src="https://wikimedia.org/api/rest_v1/media/math/render/svg/23ae6772c5f58751fc6014b71d6adafb30a31c79"
class="figure__image" >}}

{{< figure src="https://wikimedia.org/api/rest_v1/media/math/render/svg/24763ff0dfe62f5567559f49569caf4f6189ae58"
class="figure__image" >}}

Угол направления вектора градиента округляется и может принимать такие значения: 0, 45, 90, 135.

{{< figure src="https://upload.wikimedia.org/wikipedia/commons/0/0c/Semicirc.jpg"
class="figure__image" >}}

#### 3) Подавление немаксимумов

Только локальные максимумы отмечаются как границы.

#### 4) Двойная пороговая фильтрация

Потенциальные границы определяются порогами.

#### 5) Трассировка области неоднозначности.

Итоговые границы определяются путём подавления всех краёв, не связанных с определенными (сильными) границами.

Перед применением детектора обычно преобразуют изображение в оттенки серого, чтобы уменьшить вычислительные затраты. 
Этот этап характерен для многих методов обработки изображений.

{{< figure src="https://miro.medium.com/max/566/1*XAgKINgc2c2gNa2nV3zbNQ.png"
class="figure__image" >}}

---

## Повышение контраста

### Контрастоповышающие фильтры

Повышения контраста на изображении можно добиться применяя контрастоповышающие фильтры

{{< figure src="/images/uploads/contrast-enhancing.png"
class="figure__image" >}}

{{< figure src="https://cdrpro.gitbooks.io/pp-book/content/Filtry-Contrast-Enhancement-Uvelichenie-kontrastnosti-i-Local-Equalization-Mestnoe-vyravnivanie/d7fdc4fb-c591-4d85-b6b0-0183ea5c4e22.jpg"
class="figure__image" >}}

### Эквализация гистограммы

1. Вычисление гистограммы H для исходного изображения
2. Нормализация H так что сумма столбцов равна 255
3. Вычисление интеграла гистограммы \\( H’(i) = \sum_{0≤j≤i}H(j) \\) (интерполяционная кривая) (так как интегралл это просто площадь под кривой, то это просто сумма всех бинов)
5. Получение выходного изображения по интегралу \\( dst(x,y)=H’(src(x,y)) \\)

{{< figure src="/images/uploads/histogram-equalization.png"
class="figure__image" >}}
