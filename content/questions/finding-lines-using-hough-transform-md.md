---
filename: "finding-lines-using-Hough-transform.md"
title: Поиск линий с помощью преобразования Хафа.
Summary: Преобразование Хафа — это метод для поиска линий, кругов и других
  простых форм на изображении.
date: 2022-01-07T16:09:53.851Z
билеты: Билет 9
draft: false
weight: 14
author: Sergey Kryukov
cover:
  image: https://learnopencv.com/wp-content/uploads/2019/03/line-detection.jpg
---

## Что такое преобразование Хафа?

**Преобразование Хафа** — это метод обнаружения прямых и кривых линий на полутоновых или цветных изображениях.
Метод позволяет указать параметры семейства кривых и обеспечивает поиск на изображении множества кривых заданного семейства.

## Области применения 

При автоматизированном анализе цифровых изображений очень часто возникает проблема определения простых фигур, 
таких как прямые, круги или эллипсы. Во многих случаях используется алгоритм детектирования границ в качестве 
пред обработки для получения точек, находящихся на кривой в изображении. 

Однако, либо из-за зашумлённости изображения, либо из-за несовершенства алгоритма детектирования границ могут появиться 
«потерянные» точки на кривой, так же как и небольшие отклонения от идеальной формы прямой, круга или эллипса.

По этим причинам часто довольно сложно сгруппировать выделенные границы в соответствующий набор прямых, кругов и эллипсов. 
Назначение преобразования Хафа в том, чтобы разрешить проблему группировки граничных точек путём применения определённой 
процедуры голосования к набору параметризованных объектов изображения.

## Алгоритм

### Аккумуляторный массив

В алгоритме преобразования Хафа используется аккумуляторный массив, размерность которого соответствует 
количеству неизвестных параметров в уравнении семейства искомых кривых.

Например, при обнаружении прямых, описываемых уравнением \\( y=m * x+b \\), для каждой прямой необходимо вычислить значения 
двух параметров m и b. 

При этом в массиве в элементах A[M,B] накапливаются значения, указывающие на вероятность
наличия на изображении прямой \\( y=m*x+b \\), где M и B соответствуют дискретным значениям m и b.

Массив A используется в алгоритме Хаффа для проверки каждого пиксела изображения и его окрестности. 
Определяются присутствует ли в данном пикселе выраженный край (через вычисление величины градиента).

Если присутствует, то вычисляются параметры искомой кривой (определяется угол градиента), проходящей через данный пиксел. 
После оценки параметров прямой в данном пикселе они дискретизируются для получения соответствующих значений M и B, 
и значение массива A[M,B] увеличивается. 

В некоторых реализациях увеличение выполняется на единицу, в других на величину мощности края в 
обработанном пикселе. После обработки всех пикселов выполняется поиск локальных максимумов в 
аккумуляторном массиве (самый простой способ - пороговая фильтрация). 

Точки локальных максимумов соответствуют параметрам наиболее вероятных прямых на изображении. 

### PTLIST массив

Аккумуляторный массив позволяет определить параметры бесконечно протяжённых прямых или кривых, 
но с его помощью невозможно определить, где именно начинаются и заканчиваются отрезки этих линий. 

Для получения этой информации можно завести ещё одну структуру данных PTLIST. 
Элемент PTLIST[M,B] содержит список координат всех пикселов, которые внесли вклад в значение аккумуляторного 
массива A[M,B]. 

По содержанию этих списков можно найти присутствующие на изображении отрезки или сегменты кривых.

### Параметры искомых кривых

Метод Хафа может использоваться для обнаружения любых кривых, описываемых аналитически.


#### Прямые
В простейшем случае преобразование Хафа является линейным преобразованием для обнаружения прямых.

Прямая может быть задана уравнением \\( y = mx + b \\) и может быть вычислена по любой паре точек (x, y) на изображении.

Однако прямые, параллельные оси ординат, имеют бесконечные значения для параметра m.
Поэтому удобней представить прямую с помощью других параметров в виде \\( d=x * \cos{f} + y * \sin{f} \\)

d — это длина перпендикуляра к прямой (ограничен размерами изображения)

f — угол между перпендикуляром и горизонтальной осью в диапазоне [0, \\( 2\pi \\)]

В системе координат изображения оси направлены вдоль строк и столбцов изображения (ось y перевернута).

Так координата c соответствует x, а координата r — координате (-y). Тогда уравнение прямой принимает вид:

\\( d=c*\cos{f}-r*\sin{f} \\)

#### Окружности

Для обнаружения окружностей нам придётся добавить в массив A ещё одно измерение, 
т.к. стандартное описание окружности содержит три параметра:

\\( r=r0+d * \sin{f} \\)
\\( c=c0-d * \cos{f} \\)

где d — радиус окружности, а r и c — вертикальная и горизонтальная координаты центра окружности.

### Код с объяснением

{{< figure src="/images/uploads/find_line.jpg"
class="figure__image" >}}

Процедура **accumulate_lines** представляет собой версию преобразования Хафа.

Элемент **PTLIST\[M,B]** содержит список координат всех пикселов, которые внесли вклад в значение аккумуляторного массива **A\[M,B]**.

Функция **row_gradient** и **column_gradiet** обрабатывают окрестности пикселов для оценки компонент градиента в направлении строк и столбцов.

Функция **gradient** комбинирует комбинирует две эти компоненты для получения величины градиента.

if GMAG > gradient * threshold  - определяем, достаточен ли вес границы в этой точке.

Функция **atan2** возвращает по заданным компонентам градиента угол в соответствующем квадранте.

**PTLIST** - массив списков \[длина соответствующего перпендикуляра, его угол с осью абсцисс], в который включены все подходящие линии.

### Пример

Рассмотрим исходное тестовое изображение из трех черных точек. Проверим, расположены ли точки на прямой линии.

{{< figure src="https://upload.wikimedia.org/wikipedia/commons/3/39/Hough_transform_diagram.png"
class="figure__image" >}}

- Через каждую точку проведено (для наглядности) только по шесть прямых, имеющих разный угол.
- К каждой прямой из начала координат построен перпендикуляр.
- Для всех прямых длина соответствующего перпендикуляра и его угол с осью абсцисс сведены в таблицу.
- Данные таблицы являются результатом преобразования Хафа и могут служить основой для графического представления в «пространстве Хафа».

{{< figure src="https://upload.wikimedia.org/wikipedia/commons/a/af/Hough_space_plot_example.png"
class="figure__image" >}}
