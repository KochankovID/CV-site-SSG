---
filename: "optical-flow.md"
title: Оптический поток
Summary: >
  Оптический поток - получение скоростей пикселей (контрольных точек)
  из серии последовательных снимков (анимации).
date: 2022-01-10T12:15:11.592Z
билеты: Билет 11
draft: false
weight: 24
author: Sergey Krukov
cover:
  image: https://russianblogs.com/images/943/d42e49d429832f32e3fddc60869e0b7f.png
---
## Определение оптического потока

Движение объекта изображения в двух последовательных кадрах из-за движения целевого объекта или камеры называется 
**оптическим потоком**. 

Это двумерное векторное поле (поле скоростей), которое можно использовать для отображения перемещения точки от 
первого кадра изображения ко второму кадру изображения.

Суть ОП в том, что для каждой точки изображения \\( I_{1}(x,y) \\) находится такой сдвиг \\( (dx, dy) \\), 
чтобы исходной точке соответствовала точка на втором изображении \\( I_{2}(x+dx,y+dy) \\).

Как определить соответствие точек – отдельный вопрос. Для этого надо взять какую-то функцию точки, которая не изменяется 
в результате смещения. 

Обычно считается, что у точки сохраняется яркость, но можно считать одинаковыми точки, у которых сохраняется 
величина градиента, гессиан, его величина или его определитель, лапласиан, другие характеристики. 

Очевидно, сохранение яркости дает сбои, если меняется освещенность или угол падения света. 
Тем не менее, если речь идет о видеопотоке, то, скорее всего, между двумя кадрами освещение сильно не изменится, 
хотя бы потому, что между ними проходит малый промежуток времени.   

Поэтому часто используют интенсивность в качестве функции, сохраняющейся у точки.

{{< figure src="https://russianblogs.com/images/943/d42e49d429832f32e3fddc60869e0b7f.png" class="figure__image" >}}

>На изображении выше показано движение точки между пятью последовательными изображениями. Стрелка представляет вектор поля оптического потока. 

Оптический поток основан на следующих предположениях: 
1. Значение серого пикселя (целевого объекта) не изменяется между двумя последовательными изображениями. 
2. Соседние пиксели имеют одинаковое движение.

## Применение

Оптический поток полезен во многих областях: структура реконструкции движения, сжатие видео, стабилизация видео.

Исследования оптического потока широко ведутся в областях сжатия видео и анализа движений. 
Алгоритмы оптического потока не только определяют поле потока, но и используют оптический поток при 
анализе трехмерной сущности и структуры сцены, а также 3D-движения объектов и наблюдателя относительно сцены.

Оптический поток используется в робототехнике при распознавании объектов, слежении за объектами, 
определении движения и при навигации робота.

## Методы определения оптического потока

### Преобразование Фурье

Для вырожденных случаев можно применять более простые методы определения сдвига. 

В частности, если все точки изображения имеют один и тот же сдвиг (изображение сдвинуто целиком), 
то можно применить метод фазовой корреляции: вычислить преобразование Фурье для обоих изображений, 
найти свертку их фаз и по ней определить сдвиг (см. en.wikipedia.org/wiki/Phase_correlation).

### Метод Лукаса-Канаде

Предположим, что значения пикселей переходят из одного кадра в следующий без изменений. 

Таким образом, мы делаем допущение, что пиксели, относящиеся к одному и тому же объекту, могут
сместиться в какую либо сторону, но их значение останется неизменным.

На математическом языке это допущение можно записать так:

\\( I(x,y,t) = I(x+dx, y+dy, t+1) \\).

\\( I \\) — это функция яркости пикселей от положения на кадре и времени

\\( dx, dy \\) - смещение

\\( t \\) - номер кадра в последовательности

Пусть \\( I_1=I(x,y,t_1) \\) – интенсивность в некоторой точке \\( (x, y) \\) на первом изображении.

На втором изображении эта точка сдвинулась на \\( (dx, dy) \\), при этом прошло время \\( dt \\), тогда

\\( I_2=I(x+dx, y+dy, t+dt) \\)

Разложим эту функцию в ряд Тейлора

\\( I_2 \approx I_1 + I_xdx + I_ydy + I_tdt \\) (до первого члена)

\\( I_x, I_y, I_t \\) - частные производные по координатам и времени

\\( I_tdt \\) - изменения яркости в точке \\( (x, y) \\) между двумя кадрами

Мы считаем, что у точки сохранилась интенсивность, значит

\\( I_1 = I_2 \rightarrow I_xdx + I_ydy + I_tdt = 0\\)

Получаем одно уравнение с двумя неизвестными \\( (dx, dy) \\), значит его недостаточно для решения, 
то есть только на этом уравнении далеко не уедешь. 

Самое простое решение проблемы – алгоритм Лукаса-Канаде. 
У нас же на изображении объекты размером больше 1 пикселя, значит, скорее всего, в окрестности текущей точки 
у других точек будут примерно такие же сдвиги. 


Предположим, что соседние пиксели смещаются на одинаковое расстояние. Возьмем фрагмент изображения, 
скажем 5 на 5 пикселей, и условимся, что для каждого из 25 пикселей \\( dx \\) и \\( dy \\) равны.

Тогда вместо одного уравнения мы получим сразу 25 уравнений! 

Очевидно, что в общем случае система не имеет решения, 
поэтому будем искать такие \\( dx \\) и \\( dy \\), которые минимизируют ошибку (методом наименьших квадратов):

{{< figure src="https://habrastorage.org/r/w1560/storage2/0f4/37e/0d7/0f437e0d78de4c4d4c6d2823f455886c.png" 
class="figure__image" >}}

\\( g \\) - функция, определяющая весовые коэффициенты для пикселей. 
Самые распространенный вариант — двухмерная гауссиана, которая дает наибольший вес 
центральному пикселю и все меньший по мере удаления от центра.

\\( u_x, u_y \\) = \\( dx, dy \\)

С целью нахождения минимума находим частные производные по \\( u_x, u_y \\)

{{< figure src="https://habrastorage.org/r/w1560/storage2/09f/33c/7bc/09f33c7bcd20f66a0d22d20576c6fc7f.png"
class="figure__image" >}}

{{< figure src="https://habrastorage.org/r/w1560/storage2/52e/3c0/238/52e3c023850d104b16da99d7489081b1.png"
class="figure__image" >}}

Перепишем в более компактной форме и приравняем к нулю:

{{< figure src="https://habrastorage.org/r/w1560/storage2/f6a/05e/dbd/f6a05edbdbe59f995fb532b09b736f0d.png"
class="figure__image" >}}

{{< figure src="https://habrastorage.org/r/w1560/storage2/f82/fcb/fa1/f82fcbfa1cc383ca7641d2aaedb6d2dc.png"
class="figure__image" >}}

Перепишем эти два уравнения в матричной форме:

{{< figure src="https://habrastorage.org/r/w1560/storage2/4bf/580/2e7/4bf5802e7f57cfc47d85aafe97e213ad.png"
class="figure__image" >}}

Где

{{< figure src="https://habrastorage.org/r/w1560/storage2/ad6/e7d/ad5/ad6e7dad507b089f83e3e33f0a60d639.png"
class="figure__image" >}}

{{< figure src="https://habrastorage.org/r/w1560/storage2/a18/74e/56d/a1874e56d4ce4cc79677b0149341982c.png"
class="figure__image" >}}

{{< figure src="https://habrastorage.org/r/w1560/storage2/2b7/4d8/014/2b74d8014696ab5a958deffda18432bc.png"
class="figure__image" >}}

Как известно, эта система имеет единственное решение не всегда (хотя и очень часто): 
если детерминант системы равен нулю, то решений либо нет, либо бесконечное число.

> Эта проблема известна как Aperture problem – неоднозначность сдвига при ограниченном поле зрения для 
> периодических картинок.

> Она соответствует случаю, когда в поле зрения попадает фрагмент изображения, 
> в котором присутствует некоторая цикличность; тут уж и человек не сможет однозначно определить, куда картинка сместилась.

Если матрица М обратима (определитель не равен 0), можем вычислить \\( u_x, u_y \\), которые минимизируют ошибку E:

{{< figure src="https://habrastorage.org/r/w1560/storage2/979/a80/7d3/979a807d3ca1877868aed548f4eff71d.png"
class="figure__image" >}}

Вот собственно и все. Мы знаем приблизительное смещение пикселей между двумя соседними кадрами.

> Поскольку в нахождении смещения каждого пикселя участвуют также соседние с ним пиксели, 
> при реализации данного метода целесообразно предварительно посчитать производные кадра по горизонтали и вертикали. 

### Недостатки метода

Описанный выше метод основан на трех значительных допущениях, которые с одной стороны дают нам 
принципиальную возможность определить оптический поток, но с другой стороны вносят погрешность (с которой можно бороться).

1. Мы предполагали, что для аппроксимации смещения нам будет достаточно первой производной. 
В общем случае это конечно же не так (смещение можно вычислять итеративно).

2. По своей природе данный метод является локальным, то есть при определении смещения конкретного 
пикселя принимается во внимание только область вокруг этого пикселя — локальная окрестность. 
Как следствие, невозможно определить смещения внутри достаточно больших (больше размера локальной окрестности) 
равномерно окрашенных участков кадра. 
К счастью на реальных кадрах такие участки встречаются не часто, но эта особенность все же вносит дополнительное 
отклонение от истинного смещения. 

3. Ещё одна проблема связана с тем, что некоторые текстуры в изображении дают вырожденную матрицу М, 
для которой не может быть найдена обратная матрица. 
Соответственно, для таких текстур мы не сможем определить смещение. 
То есть движение вроде есть, но непонятно в какую сторону. 
В общем-то от этой проблемы страдает не только рассмотренный метод. Даже глаз человека воспринимает такое движение не однозначно.
